<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - server/api/routers/post.ts</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>server/api/routers/post.ts</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">57.80</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">184</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">32.21</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.47</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">import { z } from &quot;zod&quot;;

import {
  createTRPCRouter,
  protectedProcedure,
  publicProcedure,
} from &quot;~/server/api/trpc&quot;;

const createPostSchema = z.object({
  title: z.string(),
  description: z.string(),
  photoUrls: z.array(z.string()),
  location: z.object({
    lat: z.number(),
    lng: z.number(),
  }),
});

// Export the inferred type for frontend use
export type CreatePostInput = z.infer&lt;typeof createPostSchema&gt;;

export const postRouter = createTRPCRouter({
  createPost: publicProcedure
    .input(createPostSchema)
    .mutation(async ({ ctx, input }) =&gt; {
      const postData = {
        title: input.title,
        description: input.description,
        photoUrls: input.photoUrls,
        locationLat: input.location.lat,
        locationLng: input.location.lng,
        ...(ctx.session?.user?.id &amp;&amp; { createdById: ctx.session.user.id }),
      };

      return ctx.db.post.create({
        data: postData,
      });
    }),

  getMyPosts: protectedProcedure.query(({ ctx }) =&gt; {
    return ctx.db.post.findMany({
      where: { createdById: ctx.session.user.id },
      orderBy: { createdAt: &quot;desc&quot; },
    });
  }),

  getAllPosts: publicProcedure.query(async ({ ctx, input }) =&gt; {
    const posts = await ctx.db.post.findMany({
      orderBy: { createdAt: &quot;desc&quot; },
      include: {
        createdBy: {
          select: { name: true, id: true },
        },
        votes: {
          select: {
            isUpvote: true,
            userId: true,
          },
        },
      },
    });

    // Calculate vote counts and user vote status
    const postsWithVotes = posts.map((post) =&gt; {
      const upvotes = post.votes.filter(
        (vote) =&gt; vote.isUpvote === true,
      ).length;
      const downvotes = post.votes.filter(
        (vote) =&gt; vote.isUpvote === false,
      ).length;
      const userVote = ctx.session?.user?.id
        ? post.votes.find((vote) =&gt; vote.userId === ctx.session!.user.id)
        : null;

      return {
        ...post,
        upvotes,
        downvotes,
        userVote: userVote ? (userVote.isUpvote ? &quot;UPVOTE&quot; : &quot;DOWNVOTE&quot;) : null,
        votes: undefined, // Remove the votes array from the response
      };
    });

    return postsWithVotes;
  }),

  vote: protectedProcedure
    .input(
      z.object({
        postId: z.number(),
        isUpvote: z.boolean(), // true for upvote, false for downvote
      }),
    )
    .mutation(async ({ ctx, input }) =&gt; {
      const userId = ctx.session.user.id;

      // Check if user already voted on this post
      const existingVote = await ctx.db.vote.findUnique({
        where: {
          userId_postId: {
            userId: userId,
            postId: input.postId,
          },
        },
      });

      if (existingVote) {
        // If user voted the same way, remove the vote (toggle off)
        if (existingVote.isUpvote === input.isUpvote) {
          await ctx.db.vote.delete({
            where: {
              id: existingVote.id,
            },
          });
          return { success: true, action: &quot;removed&quot; };
        } else {
          // If user voted differently, update the vote
          await ctx.db.vote.update({
            where: {
              id: existingVote.id,
            },
            data: {
              isUpvote: input.isUpvote,
            },
          });
          return { success: true, action: &quot;updated&quot; };
        }
      } else {
        // Create new vote
        await ctx.db.vote.create({
          data: {
            userId: userId,
            postId: input.postId,
            isUpvote: input.isUpvote,
          },
        });
        return { success: true, action: &quot;created&quot; };
      }
    }),

  removeVote: protectedProcedure
    .input(
      z.object({
        postId: z.number(),
      }),
    )
    .mutation(async ({ ctx, input }) =&gt; {
      const { postId } = input;
      const userId = ctx.session.user.id;

      await ctx.db.vote.delete({
        where: {
          userId_postId: {
            userId,
            postId,
          },
        },
      });

      return { success: true };
    }),

  getPostVotes: publicProcedure
    .input(z.object({ postId: z.number() }))
    .query(async ({ ctx, input }) =&gt; {
      const votes = await ctx.db.vote.findMany({
        where: { postId: input.postId },
      });

      const upvotes = votes.filter((vote) =&gt; vote.isUpvote).length;
      const downvotes = votes.filter((vote) =&gt; !vote.isUpvote).length;

      const userVote = ctx.session?.user?.id
        ? votes.find((vote) =&gt; vote.userId === ctx.session!.user.id)
        : null;

      return {
        upvotes,
        downvotes,
        userVote: userVote ? userVote.isUpvote : null,
      };
    }),
});
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
