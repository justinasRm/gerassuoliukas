<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - app/components/UploadThingDrop.tsx</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>app/components/UploadThingDrop.tsx</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">60.62</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">411</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">44.63</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.60</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">import { useFormContext } from &quot;react-hook-form&quot;;
import { useDropzone } from &quot;@uploadthing/react&quot;;
import { useUploadThing } from &quot;~/utils/uploadthing&quot;;
import type { CreatePostFormData } from &quot;./pages/ZemelapisScreen&quot;;
import { twMerge } from &quot;tailwind-merge&quot;;
import {
  useState,
  useCallback,
  useEffect,
  forwardRef,
  useImperativeHandle,
  useRef,
} from &quot;react&quot;;
import { generateClientDropzoneAccept } from &quot;uploadthing/client&quot;;
import { Button } from &quot;./commonUi/Button&quot;;
import heic2any from &quot;heic2any&quot;;
import imageCompression from &quot;browser-image-compression&quot;;

interface FileWithPreview extends File {
  preview: string;
}

export interface UploadThingDropRef {
  uploadFiles: () =&gt; Promise&lt;string[]&gt;;
  hasFiles: () =&gt; boolean;
}

export const UploadThingDrop = forwardRef&lt;UploadThingDropRef&gt;(
  function UploadThingDrop(_, ref) {
    const { setValue, setError, clearErrors } =
      useFormContext&lt;CreatePostFormData&gt;();
    const [files, setFiles] = useState&lt;FileWithPreview[]&gt;([]);
    const [isUploading, setIsUploading] = useState(false);
    const uploadPromiseRef = useRef&lt;{
      resolve: (value: string[] | PromiseLike&lt;string[]&gt;) =&gt; void;
      reject: (reason?: unknown) =&gt; void;
    } | null&gt;(null);
    const [enlargedImageIndex, setEnlargedImageIndex] = useState&lt;number | null&gt;(
      null,
    );
    const [polaroidRotations, setPolaroidRotations] = useState&lt;number[]&gt;([]);
    const [uploadingImages, setUploadingImages] = useState&lt;number&gt;(0);

    const { startUpload } = useUploadThing(&quot;imageUploader&quot;, {
      onClientUploadComplete: (res) =&gt; {
        const uploadedUrls = res.map((r) =&gt; r.ufsUrl);
        setValue(&quot;photoUrls&quot;, uploadedUrls);
        setIsUploading(false);
        files.forEach((file) =&gt; URL.revokeObjectURL(file.preview));
        setFiles([]);

        if (uploadPromiseRef.current) {
          uploadPromiseRef.current.resolve(uploadedUrls);
          uploadPromiseRef.current = null;
        }
      },
      onUploadError: (error: Error) =&gt; {
        console.log(&quot;Upload error:&quot;, error);
        setIsUploading(false);

        if (uploadPromiseRef.current) {
          uploadPromiseRef.current.reject(error);
          uploadPromiseRef.current = null;
        }

        if (error.message.includes(&quot;FileSizeMismatch&quot;)) {
          setError(&quot;photoUrls&quot;, {
            type: &quot;manual&quot;,
            message:
              &quot;Seni, persistengei, failas per didelis.\nDaugiausiai 8MB.&quot;,
          });
        } else if (error.message.includes(&quot;FileCountMismatch&quot;)) {
          setError(&quot;photoUrls&quot;, {
            type: &quot;manual&quot;,
            message:
              &quot;Gerai, tu ne Alesius, tiek daug nuotraukų nereikia.\nDaugiausiai 3 nuotraukos.&quot;,
          });
        } else {
          setError(&quot;photoUrls&quot;, {
            type: &quot;manual&quot;,
            message:
              &quot;Kažkas nepavyko. elektra dingo, rezisteris sprogo, ar dar kas nors, nežinau.\nPerkrauk ir bandyk iš naujo.&quot;,
          });
        }
      },
      onUploadBegin: () =&gt; {
        setIsUploading(true);
      },
    });

    const validateFiles = (filesToValidate: File[]): string | null =&gt; {
      if (filesToValidate.length &gt; 3) {
        return &quot;Gerai, tu ne Alesius, tiek daug nuotraukų nereikia.\nDaugiausiai 3 nuotraukos.&quot;;
      }

      for (const file of filesToValidate) {
        const isImage =
          file.type.startsWith(&quot;image/&quot;) ||
          file.type === &quot;image/heic&quot; ||
          file.type === &quot;image/heif&quot; ||
          file.name.toLowerCase().endsWith(&quot;.heic&quot;) ||
          file.name.toLowerCase().endsWith(&quot;.heif&quot;);

        if (!isImage) {
          return &quot;Tik nuotraukos leidžiamos, ne video ar dokumentai.&quot;;
        }

        if (file.size &gt; 8 * 1024 * 1024) {
          return &quot;Seni, persistengei, failas per didelis.\nDaugiausiai 8MB.&quot;;
        }
      }

      return null;
    };

    const processImage = async (file: File): Promise&lt;File&gt; =&gt; {
      let processedFile = file;

      // Convert HEIC to JPEG if needed
      if (
        file.type === &quot;image/heic&quot; ||
        file.type === &quot;image/heif&quot; ||
        file.name.toLowerCase().endsWith(&quot;.heic&quot;) ||
        file.name.toLowerCase().endsWith(&quot;.heif&quot;)
      ) {
        try {
          const convertedBlob = await heic2any({
            blob: file,
            toType: &quot;image/jpeg&quot;,
            quality: 0.9,
          });

          const blob = Array.isArray(convertedBlob)
            ? convertedBlob[0]
            : convertedBlob;
          if (blob) {
            processedFile = new File(
              [blob],
              file.name.replace(/\.(heic|heif)$/i, &quot;.jpg&quot;),
              {
                type: &quot;image/jpeg&quot;,
                lastModified: file.lastModified,
              },
            );
          }
        } catch (error) {
          console.error(&quot;HEIC conversion failed:&quot;, error);
        }
      }

      try {
        const compressedFile = await imageCompression(processedFile, {
          maxSizeMB: 2,
          maxWidthOrHeight: 1920,
          useWebWorker: true,
          fileType: processedFile.type,
        });

        return compressedFile;
      } catch (error) {
        console.error(&quot;Image compression failed:&quot;, error);
        return processedFile; // Return original if compression fails
      }
    };

    const onDrop = useCallback(
      async (acceptedFiles: File[]) =&gt; {
        const validationError = validateFiles(acceptedFiles);
        if (validationError) {
          setError(&quot;photoUrls&quot;, {
            type: &quot;manual&quot;,
            message: validationError,
          });
          return;
        }

        clearErrors(&quot;photoUrls&quot;);
        setIsUploading(true); // Show loading state during processing

        try {
          // Process all images (HEIC conversion + compression)
          const processedFiles = await Promise.all(
            acceptedFiles.map(processImage),
          );

          const filesWithPreview = processedFiles.map((file) =&gt;
            Object.assign(file, {
              preview: URL.createObjectURL(file),
            }),
          );

          setFiles(filesWithPreview);
          setUploadingImages(filesWithPreview.length);

          // Set temporary preview URLs in the form for display
          setValue(
            &quot;photoUrls&quot;,
            filesWithPreview.map((file) =&gt; file.preview),
          );
        } catch (error) {
          console.error(&quot;Image processing failed:&quot;, error);
          setError(&quot;photoUrls&quot;, {
            type: &quot;manual&quot;,
            message:
              &quot;Kažkas negerai su nuotraukų apdorojimu. Pabandyk dar kartą.&quot;,
          });
        } finally {
          setIsUploading(false);
        }
      },
      [setValue, setError, clearErrors],
    );

    useEffect(() =&gt; {
      setPolaroidRotations(files.map(() =&gt; Math.random() * 20 - 10));
      setUploadingImages(0);
    }, [files.length]);

    const uploadFiles = useCallback(async (): Promise&lt;string[]&gt; =&gt; {
      if (files.length &gt; 0 &amp;&amp; !isUploading) {
        return new Promise&lt;string[]&gt;((resolve, reject) =&gt; {
          uploadPromiseRef.current = { resolve, reject };
          void startUpload(files);
        });
      }
      return [];
    }, [files, isUploading, startUpload]);

    const hasFiles = useCallback(() =&gt; {
      return files.length &gt; 0;
    }, [files]);

    // Expose functions to parent component
    useImperativeHandle(ref, () =&gt; ({
      uploadFiles,
      hasFiles,
    }));

    useEffect(() =&gt; {
      return () =&gt; {
        files.forEach((file) =&gt; URL.revokeObjectURL(file.preview));
      };
    }, [files]);

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
      onDrop,
      accept: {
        ...generateClientDropzoneAccept([&quot;image/*&quot;]),
        &quot;image/heic&quot;: [&quot;.heic&quot;],
        &quot;image/heif&quot;: [&quot;.heif&quot;],
      },
      multiple: true,
      maxFiles: 3,
    });

    const removeFile = (indexToRemove: number) =&gt; {
      const updatedFiles = files.filter((_, index) =&gt; index !== indexToRemove);

      // Revoke the URL for the removed file
      URL.revokeObjectURL(files[indexToRemove]!.preview);

      setFiles(updatedFiles);
      setValue(
        &quot;photoUrls&quot;,
        updatedFiles.map((file) =&gt; file.preview),
      );

      if (updatedFiles.length === 0) {
        clearErrors(&quot;photoUrls&quot;);
      }
    };

    return (
      &lt;div className=&quot;space-y-4&quot;&gt;
        &lt;div
          {...getRootProps()}
          className={twMerge(
            &quot;cursor-pointer rounded-lg border-2 border-dashed border-green-500 p-6 text-center transition-colors&quot;,
            isDragActive
              ? &quot;border-green-400 bg-green-500/10&quot;
              : &quot;hover:border-green-400 hover:bg-green-500/5&quot;,
          )}
        &gt;
          &lt;input {...getInputProps()} /&gt;
          &lt;div className=&quot;flex flex-col items-center justify-center space-y-2&quot;&gt;
            &lt;div className=&quot;text-green-500&quot;&gt;
              &lt;svg
                className=&quot;h-8 w-8&quot;
                fill=&quot;none&quot;
                stroke=&quot;currentColor&quot;
                viewBox=&quot;0 0 24 24&quot;
              &gt;
                &lt;path
                  strokeLinecap=&quot;round&quot;
                  strokeLinejoin=&quot;round&quot;
                  strokeWidth={2}
                  d=&quot;M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12&quot;
                /&gt;
              &lt;/svg&gt;
            &lt;/div&gt;
            &lt;div className=&quot;text-white&quot;&gt;
              {isUploading
                ? &quot;Apdorojamos nuotraukos...&quot;
                : isDragActive
                  ? &quot;Paleisk :)&quot;
                  : files.length &gt; 0
                    ? `Pasirinkt${files.length === 1 ? &quot;a&quot; : &quot;os&quot;} ${files.length} nuotrauk${files.length === 1 ? &quot;a&quot; : &quot;os&quot;}`
                    : &quot;Pasirink nuotrauką/as, arba timptelk jas čia&quot;}
            &lt;/div&gt;
            &lt;div className=&quot;text-sm text-white/70&quot;&gt;
              Iki 3 nuotraukų, kiekvienos dydis iki 8MB.
            &lt;/div&gt;
            {files.length === 0 &amp;&amp; !isUploading &amp;&amp; (
              &lt;Button
                variant=&quot;primary&quot;
                size=&quot;sm&quot;
                className=&quot;mt-2&quot;
                type=&quot;button&quot;
              &gt;
                Pasirink failus
              &lt;/Button&gt;
            )}
            {isUploading &amp;&amp; (
              &lt;div className=&quot;mt-2 text-sm text-green-400&quot;&gt;Keliama...&lt;/div&gt;
            )}
          &lt;/div&gt;
        &lt;/div&gt;

        {files.length &gt; 0 &amp;&amp; (
          &lt;div className=&quot;my-6 px-5&quot;&gt;
            &lt;div&gt;
              &lt;p className=&quot;mb-6 text-center text-sm text-white/70&quot;&gt;
                {uploadingImages &gt; 0
                  ? &quot;Keliama...&quot;
                  : `Bus keliam${files.length === 1 ? &quot;a&quot; : &quot;os&quot;} šit${files.length === 1 ? &quot;a&quot; : &quot;os&quot;}:`}
              &lt;/p&gt;
              &lt;div className=&quot;flex flex-wrap justify-center gap-4&quot;&gt;
                {files.map((file, index) =&gt; (
                  &lt;div
                    key={`polaroid-${index}`}
                    className={`relative transform cursor-pointer bg-[hsl(118,100%,70%)] p-3 shadow-lg transition-all duration-200 ${
                      enlargedImageIndex === index &amp;&amp;
                      &quot;fixed inset-0 z-50 flex items-center justify-center&quot;
                    }`}
                    style={{
                      transform:
                        enlargedImageIndex === index
                          ? &quot;scale(2) translate(0, 0)&quot;
                          : `rotate(${polaroidRotations[index] || Math.random() * 20 - 10}deg)`,
                    }}
                    onClick={() =&gt;
                      setEnlargedImageIndex(
                        enlargedImageIndex === index ? null : index,
                      )
                    }
                  &gt;
                    &lt;div
                      className={
                        enlargedImageIndex === index
                          ? &quot;relative flex flex-col justify-center&quot;
                          : &quot;flex flex-col justify-center&quot;
                      }
                    &gt;
                      &lt;img
                        src={file.preview}
                        alt={`Suoliukas ${index + 1}`}
                        className={`h-32 max-w-42 object-cover sm:max-w-60`}
                      /&gt;
                      &lt;div className=&quot;mt-2 text-center text-xs font-black text-gray-800&quot;&gt;
                        Suoliukas #{index + 1}
                      &lt;/div&gt;
                      &lt;div className=&quot;text-center text-xs font-medium text-gray-800&quot;&gt;
                        {new Date().toLocaleDateString(&quot;lt-LT&quot;)}
                      &lt;/div&gt;
                      {enlargedImageIndex === index &amp;&amp; (
                        &lt;div className=&quot;absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-[hsl(118,100%,70%)] text-xs font-bold text-black&quot;&gt;
                          ✕
                        &lt;/div&gt;
                      )}
                    &lt;/div&gt;
                    {/* Remove button for non-enlarged images */}
                    {enlargedImageIndex !== index &amp;&amp; (
                      &lt;button
                        type=&quot;button&quot;
                        onClick={(e) =&gt; {
                          e.stopPropagation();
                          removeFile(index);
                        }}
                        className=&quot;absolute -top-3 -right-3 flex h-7 w-7 items-center justify-center rounded-full border-2 border-white bg-green-700 font-black text-white hover:bg-green-900&quot;
                      &gt;
                        ×
                      &lt;/button&gt;
                    )}
                  &lt;/div&gt;
                ))}
              &lt;/div&gt;

              {enlargedImageIndex !== null &amp;&amp; (
                &lt;div
                  className=&quot;fixed inset-0 z-40 bg-black/80&quot;
                  onClick={() =&gt; setEnlargedImageIndex(null)}
                /&gt;
              )}
            &lt;/div&gt;
          &lt;/div&gt;
        )}
      &lt;/div&gt;
    );
  },
);
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
